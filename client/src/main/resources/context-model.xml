<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2017 Skolkovo Institute of Science and Technology
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xsi:schemaLocation="http://www.springframework.org/schema/beans              http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util               http://www.springframework.org/schema/util/spring-util.xsd
                           http://www.springframework.org/schema/task               http://www.springframework.org/schema/task/spring-task.xsd
                           http://www.springframework.org/schema/integration        http://www.springframework.org/schema/integration/spring-integration.xsd
                           http://www.springframework.org/schema/integration/file   http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

    <bean id="repositoryStateMachine" class="ru.skoltech.cedl.dataexchange.db.RepositoryStateMachine"/>

    <bean id="actionLogger" class="ru.skoltech.cedl.dataexchange.logging.ActionLogger">
        <property name="applicationSettings" ref="applicationSettings"/>
        <property name="project" ref="project"/>
    </bean>

    <bean id="project" class="ru.skoltech.cedl.dataexchange.structure.Project">
        <property name="applicationSettings" ref="applicationSettings"/>
        <property name="repositoryStateMachine" ref="repositoryStateMachine"/>
        <property name="differenceHandler" ref="differenceHandler"/>
        <property name="parameterLinkRegistry" ref="parameterLinkRegistry"/>
        <property name="externalModelFileWatcher" ref="externalModelFileWatcher"/>
        <property name="externalModelFileHandler" ref="externalModelFileHandler"/>
        <property name="fileStorageService" ref="fileStorageService"/>
        <property name="studyService" ref="studyService"/>
        <property name="userManagementService" ref="userManagementService"/>
        <property name="userRoleManagementService" ref="userRoleManagementService"/>
        <property name="unitManagementService" ref="unitManagementService"/>
        <property name="inboundFilesChannel" ref="inboundFilesChannel"/>
        <property name="executor" ref="executor"/>
    </bean>

    <util:map id="builderRegistry" map-class="java.util.HashMap">
        <entry value-ref="simpleSystemBuilder">
            <key>
                <bean factory-bean="simpleSystemBuilder" factory-method="asName"/>
            </key>
        </entry>
        <entry value-ref="basicSpaceSystemBuilder">
            <key>
                <bean factory-bean="basicSpaceSystemBuilder" factory-method="asName"/>
            </key>
        </entry>
    </util:map>

    <bean id="systemBuilderFactory" class="ru.skoltech.cedl.dataexchange.structure.SystemBuilderFactory">
        <constructor-arg name="builderRegistry" ref="builderRegistry"/>
    </bean>

    <bean id="systemBuilder" class="ru.skoltech.cedl.dataexchange.structure.SystemBuilder" abstract="true">
        <property name="unitManagementService" ref="unitManagementService"/>
    </bean>

    <bean id="simpleSystemBuilder" class="ru.skoltech.cedl.dataexchange.structure.SimpleSystemBuilder"
          parent="systemBuilder"/>

    <bean id="basicSpaceSystemBuilder" class="ru.skoltech.cedl.dataexchange.structure.BasicSpaceSystemBuilder"
          parent="systemBuilder"/>

    <bean id="differenceHandler" class="ru.skoltech.cedl.dataexchange.structure.DifferenceHandler">
        <property name="externalModelUpdateHandler" ref="externalModelUpdateHandler"/>
        <property name="studyService" ref="studyService"/>
        <property name="nodeDifferenceService" ref="nodeDifferenceService"/>
        <property name="externalModelFileHandler" ref="externalModelFileHandler"/>
    </bean>

    <bean id="externalModelUpdateHandler" class="ru.skoltech.cedl.dataexchange.structure.update.ExternalModelUpdateHandler">
        <property name="externalModelAccessorFactory" ref="externalModelAccessorFactory"/>
        <property name="parameterLinkRegistry" ref="parameterLinkRegistry"/>
        <property name="externalModelFileStorageService" ref="externalModelFileStorageService"/>
        <property name="externalModelFileHandler" ref="externalModelFileHandler"/>
        <property name="externalModelFileWatcher" ref="externalModelFileWatcher"/>
    </bean>

    <bean id="parameterLinkRegistry" class="ru.skoltech.cedl.dataexchange.structure.analytics.ParameterLinkRegistry">
        <property name="project" ref="project"/>
        <property name="actionLogger" ref="actionLogger"/>
    </bean>

    <bean id="externalModelFileWatcher" class="ru.skoltech.cedl.dataexchange.external.ExternalModelFileWatcher">
        <property name="directoryWatchService" ref="directoryWatchService"/>
    </bean>

    <bean id="externalModelFileHandler" class="ru.skoltech.cedl.dataexchange.external.ExternalModelFileHandler">
        <property name="project" ref="project"/>
        <property name="externalModelFileWatcher" ref="externalModelFileWatcher"/>
        <property name="externalModelUpdateHandler" ref="externalModelUpdateHandler"/>
        <property name="fileStorageService" ref="fileStorageService"/>
        <property name="externalModelFileStorageService" ref="externalModelFileStorageService"/>
    </bean>

    <bean id="externalModelAccessorFactory" class="ru.skoltech.cedl.dataexchange.external.ExternalModelAccessorFactory"/>

    <bean id="tradespaceModelBridge" class="ru.skoltech.cedl.dataexchange.entity.tradespace.TradespaceToStudyBridge"
          scope="prototype">
        <constructor-arg ref="project"/>
    </bean>

    <!-- integration -->
    <int-file:inbound-channel-adapter id="inboundFilesChannel" channel="outboundFilesChannel"
                                      directory="file:${cedesk.app.dir}"
                                      filename-regex="^.*\.(xls|xlsx|xlsm)$"
                                      auto-create-directory="false" auto-startup="false"
                                      use-watch-service="true" watch-events="MODIFY,DELETE">
        <int:poller id="poller" fixed-rate="100" task-executor="executor"/>
    </int-file:inbound-channel-adapter>

    <int:outbound-channel-adapter id="outboundFilesChannel"  method="onFileModify" ref="externalModelFileWatcher" />

    <!-- Schedule a task for regular checking new version of remote study -->
    <task:scheduler id="scheduler"/>
    <task:scheduled-tasks scheduler="scheduler">
        <task:scheduled ref="project" method="checkStudyInRepository" fixed-delay="${repository.scheduler.delay}"/>
    </task:scheduled-tasks>

</beans>